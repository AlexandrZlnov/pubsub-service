## PubSub Service

Представлена реализация gRPC сервиса PubSub с использованием шины событий subpub. Сервис позволяет подписываться на события по ключам и публиковать события для всех подписчиков конкретного ключа.

### Сервис предоставляет три основных метода:
- Subscribe - подписка на события по ключу (server-side streaming)  
- Publish - публикация сообщения для всех подписчиков ключа
- Close - закрытие сервиса и освобождение ресурсов
    
### Сервис построен на основе:  
- gRPC для транспорта  
- внутренней шины событий (subpub)  
- конфигурируемых параметров работы  

### Основные компоненты:  
1. Шина событий (subpub):  
   - реализует механизм подписки/публикации  
    - роддерживает несколько подписчиков на один ключ  
    - гарантирует порядок доставки сообщений (FIFO)  
    - обрабатывает медленных подписчиков без блокировки системы  
2. gRPC сервер:  
   - принимает запросы от клиентов
   - преобразует gRPC вызовы в операции с шиной событий
   - логирует операции
   - поддерживает graceful shutdown  
3. Сервис PubSub:
   - связывает gRPC интерфейс с шиной событий
   - управляет жизненным циклом подписок
   - обрабатывает ошибки  

### Передача данных:  
- клиент вызывает Subscribe с ключом подписки  
- сервер создает подписку на шине событий  
- когда другой клиент публикует сообщение по этому ключу:
    - сообщение попадает в шину событий
    - шина доставляет сообщение всем подписчикам
    - сервер пересылает сообщение клиенту через gRPC стрим  
  - при отмене контекста или закрытии соединения подписка удаляется  

### Особенности реализации  
- подписка на события по ключам (streaming gRPC)  
- публикация событий для всех подписчиков ключа  
- поддержка паттернов  
- конфигурируемые параметры сервиса  
- логирование всех операций  
- потокобезопасная реализация  
- дополнительно:
    - буферизованные каналы для сообщений (размер 100)  
    - неблокирующая отправка при переполнении очереди  
    - поддержка конкурентного доступа  

### Использованные паттерны  
- Publisher-Subscriber - ядро системы, реализованное в пакете subpub  
- Graceful Shutdown - корректное завершение работы с ожиданием обработки сообщений  
- Dependency Injection - внедрение зависимостей (логгер, конфиг) через конструкторы  
- Interceptors - gRPC-интерцепторы для логирования запросов  
- Sync primitives - использование мьютексов и каналов для потокобезопасности  

* * * *
### Структура проекта  
    pubsub-service/
    ├── cmd/
    │   └── server/
    │       └── main.go
    ├── config/
    │   └── config.go
    ├── internal/
    │   ├── server/
    │   │   └── server.go
    │   └── service/
    │       ├── service.go
    │       └── service_test.go
    ├── proto/
    │   └── pubsub.proto
    ├── subpub/
    │   ├── subpub.go
    │   └── subpub_test.go
    ├── go.mod
    └── go.sum

* * * *
### Сборка и запуск  

Генерация protobuf файлов уже выполнена  

**Шаг 1. Клонирование**  
    - `git clone https://github.com/AlexandrZlnov/pubsub-service.git` или `git clone git@github.com:AlexandrZlnov/pubsub-service.git`  
    - `cd pubsub-service`  

**Шаг2. Сборка сервера**  
    - `go build -o pubsub-server ./cmd/server`  

**Шаг3. Запуск**  
    - `go run cmd/server/main.go`  
    или  
    - `./pubsub-server`  

**При необходимости генерации protobuf (для MacOS):**  
    - `brew install protobuf`  
    - `go install google.golang.org/protobuf/cmd/protoc-gen-go@latest`  
    - `go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest`  
    - `protoc --go_out=./proto --go-grpc_out=./proto proto/pubsub.proto`  

* * * *
### Тестирование  
`go test  -v ./subpub/...`  

#### Для тестирования можно использовать gRPC клиент grpcurl:  
- Подписаться на события:  
  `grpcurl -plaintext -d '{"key": "test"}' localhost:50051 pubsub.PubSub/Subscribe`  
- Опубликовать событие:  
  `grpcurl -plaintext -d '{"key": "test", "data": "hello"}' localhost:50051 pubsub.PubSub/Publish`  
